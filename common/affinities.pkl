open module hpkl.common.k8s.affinities

import "@k8s/api/core/v1/PodSpec.pkl"

class PodAntiAffinityConfig {
  preset: "soft"| "hard" = "soft"
  topologyKey: String = "kubernetes.io/hostname"
  selectorLabels: Mapping<String, String>
}

podAntiAffinityConfig: PodAntiAffinityConfig = new {}

config: PodSpec.Affinity = new {
  podAntiAffinity = new {
    when (podAntiAffinityConfig.preset == "soft") {
      preferredDuringSchedulingIgnoredDuringExecution {
        new {
          weight = 1
          podAffinityTerm {
            labelSelector {
              matchLabels = podAntiAffinityConfig.selectorLabels
            }
            topologyKey = podAntiAffinityConfig.topologyKey
          }
        }
      }
    }
    when (podAntiAffinityConfig.preset == "hard") {
        requiredDuringSchedulingIgnoredDuringExecution {
            new {
                labelSelector {
                    matchLabels = podAntiAffinityConfig.selectorLabels
                }
                topologyKey = podAntiAffinityConfig.topologyKey
            }
        }
    }
  }
}

output {
  renderer = new YamlRenderer {}
  value = config
}
